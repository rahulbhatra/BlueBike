---
title: "GAM"
output: rmarkdown::github_document
date: "2022-11-21"
---

```{r}
head(data)

trainIndex <- c(seq(1, 0.8*nrow(data)))
testIndex <- c(seq(0.8*nrow(data) + 1, nrow(data)))

train  <- data[trainIndex, ]
test   <- data[testIndex, ]
test.x = test[c("temp", "totalCrimes", "humidity", "windspeed", "visibility", "feelslike", "uvindex")]
test.x
newx = as.matrix(test.x)
newx
```

```{r}
library("mgcv")
gam.fit = gam(totalTrips ~ temp + totalCrimes + humidity + windspeed + visibility + feelslike + uvindex, data = train)
summary(gam.fit)

gam.fit.smoothing = gam(totalTrips ~ temp + totalCrimes + humidity + windspeed + visibility + feelslike + uvindex, data = train)
summary(gam.fit.smoothing)
```

```{r}
gam.fit.sse =sum(fitted(gam.fit) - train$totalTrips)^2
gam.fit.ssr =sum(fitted(gam.fit) -mean(train$totalTrips))^2
gam.fit.rSquare = 1 - (gam.fit.sse /(gam.fit.ssr + gam.fit.sse))
cat("The R square GAM is: %s", gam.fit.rSquare)

gam.fit.smoothing.sse =sum(fitted(gam.fit.smoothing) - train$totalTrips)^2
gam.fit.smoothing.ssr =sum(fitted(gam.fit.smoothing) -mean(train$totalTrips))^2
gam.fit.smoothing.rSquare = 1 - (gam.fit.smoothing.sse /(gam.fit.smoothing.ssr + gam.fit.smoothing.sse))
cat("The R square GAM is: %s", gam.fit.smoothing.rSquare)
```

```{r}
library("ggplot2")
predicted = predict(gam.fit, newdata = test)
predicted

plot = data.frame(test$date, test$totalTrips, predicted)
plot

head(plot)
ggp = ggplot(data = plot) + 
  geom_line(aes(x = test.date, y = test.totalTrips, colour = "Test Total Trips")) + 
  geom_line(aes(x = test.date, y = predicted, colour = "GAM Fit Total Trips")) +
  scale_color_manual(name = "Test vs Predictions", values = c("Test Total Trips" = 2, "GAM Fit Total Trips" = 3))
ggp
```


*Using Cross Validation over here. The initial Window will be of length 500 and test will be of 100*

```{r}

library(tidyverse)
library(caret)
library(doParallel)

set.seed(123)
seeds <- vector(mode = "list", length = 1809)
for(i in 1:1809) seeds[[i]] <- sample.int(1000, 5, replace = FALSE)
registerDoParallel(cores=3)

myTimeControl <- trainControl(method = "timeslice",
                              initialWindow = 500,
                              horizon = 100,
                              fixedWindow = FALSE,
                              allowParallel = TRUE,
                              seeds = seeds)

```



*Regularized Linear Regression*

```{r}
tuneLength.num <- 5

glmnet.mod <- train(totalTrips ~ temp + totalCrimes + humidity + windspeed + visibility + feelslike + uvindex,
                    data = train,
                    method = "glmnet",
                    family = "gaussian",
                    trControl = myTimeControl,
                    tuneLength=tuneLength.num,
                    metric='RMSE'
                )
summary(glmnet.mod)
plot(glmnet.mod)
glmnet.mod
```

***Testing the model (Regularized Linear Regression) and plotting it's results over here.***

```{r}
bestlam = glmnet.mod$bestTune$lambda
bestlam
glmnet.pred = predict(glmnet.mod$finalModel, s = bestlam, newx = newx)
dim(glmnet.pred)
glmnet.pred

ggp = ggplot(data = test) + 
  geom_line(aes(x = date, y = totalTrips, colour = "Test Total Trips")) +
  geom_line(aes(x = date, y = glmnet.pred, colour = "Reg. LR Total Trips")) + 
  scale_color_manual(name = "Test vs Predictions", values = c("Test Total Trips" = 2, "Reg. LR Total Trips" = 3))
ggp

cat("Train RMSE for glmnet", mean(glmnet.mod$results$RMSE))
cat("Test RMSE for glmnet", sqrt(mean((glmnet.pred - test$totalTrips)^2)))
```

***Regularized Poisson Regression***

```{r}
pois.mod <- train(totalTrips ~ temp + totalCrimes + humidity + windspeed + visibility + feelslike + uvindex,
                    data = train,
                    method = "glmnet",
                    family = "poisson",
                    trControl = myTimeControl,
                    tuneLength = tuneLength.num,
                    metric='RMSE')
pois.mod
```

***Testing the model (Regularized Poisson Regression) and plotting it's results over here.***

```{r}
pois.mod$bestTune
bestlam = pois.mod$bestTune$lambda
bestlam
pois.pred = predict(pois.mod$finalModel, s = bestlam, newx = newx)
dim(pois.pred)
pois.pred

ggp = ggplot(data = test) + 
  geom_line(aes(x = date, y = totalTrips, colour = "Test Total Trips")) +
  # geom_line(aes(x = date, y = glmnet.pred, colour = "Reg. LR Total Trips")) + 
  geom_line(aes(x = date, y = pois.pred, colour = "Poisson Total Trips")) + 
  scale_color_manual(name = "Test vs Predictions", values = c("Test Total Trips" = 2, "Reg. LR Total Trips" = 3, "Poission Total Trips" = 4))
ggp

cat("Train RMSE for glmnet", mean(pois.mod$results$RMSE))
cat("Test RMSE for glmnet", sqrt(mean((pois.pred - test$totalTrips)^2)))
```

*Training the Gam Model.*

```{r}
train
gam.mod <- train(totalTrips ~ temp + totalCrimes + humidity + windspeed + visibility + feelslike + uvindex,
                   data = train,
                   method = "gam",
                   trControl = myTimeControl,
                   tuneLength=tuneLength.num,
                   metric='RMSE'
                 )

plot(gam.mod)
gam.mod
```
***Testing the model (Gam) and plotting it's results over here.***

```{r}
gam.mod$bestTune
gam.bestlam = gam.mod$bestTune$lambda
gam.bestlam
gam.pred = predict(gam.mod$finalModel, s = gam.bestlam, newx = newx)
dim(gam.pred)
gam.pred

ggp = ggplot(data = test) + 
  geom_line(aes(x = date, y = totalTrips, colour = "Test Total Trips")) +
  geom_line(aes(x = date, y = glmnet.pred, colour = "Reg. LR Total Trips")) +
  geom_line(aes(x = date, y = gam.pred, colour = "Gam Total Trips")) + 
  scale_color_manual(name = "Test vs Predictions", values = c("Test Total Trips" = 2, "Reg. LR Total Trips" = 3, "Gam Total Trips" = 4))
ggp

cat("Train RMSE for glmnet", mean(gam.mod$results$RMSE))
cat("Test RMSE for glmnet", sqrt(mean((gam.mod - test$totalTrips)^2)))
```


\_\* Comparing the models over here.\*\_

```{r}
resamps <- resamples(list(glmnet = glmnet.mod, glmnet.pois = pois.mod, gam=gam.mod))
ss <- summary(resamps)
knitr::kable(ss[[3]]$RMSE)
```

```{r}
trellis.par.set(caretTheme())
dotplot(resamps, metric = "RMSE")
```
